<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shvitz Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'EB Garamond', Georgia, 'Times New Roman', serif;
            background: #f7f3ed;
            color: #2a2520;
            overflow: hidden;
        }

        #password-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f7f3ed;
        }

        #password-form {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .landing-image {
            width: 560px;
            max-width: 100%;
            height: auto;
            margin-bottom: 32px;
            opacity: 0.9;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #password-form h2 {
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: #2a2520;
            margin-bottom: 48px;
        }

        #password-input {
            width: 100%;
            padding: 12px 0;
            border: none;
            border-bottom: 1px solid #2a2520;
            font-size: 16px;
            font-family: 'EB Garamond', Georgia, serif;
            background: transparent;
            color: #2a2520;
            text-align: center;
            letter-spacing: 0.1em;
        }

        #password-input:focus {
            outline: none;
            border-bottom-width: 2px;
        }

        #password-input::placeholder {
            color: #999;
        }

        button {
            margin-top: 32px;
            padding: 12px 48px;
            background: #2a2520;
            color: #f7f3ed;
            border: none;
            font-size: 12px;
            font-family: 'EB Garamond', Georgia, serif;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #4a4540;
        }

        .error {
            color: #8b4513;
            margin-top: 24px;
            font-size: 13px;
            font-style: italic;
            display: none;
        }

        #map-screen {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        #map-header {
            background: #f7f3ed;
            padding: 16px 32px;
            border-bottom: 1px solid #d9d0c3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin: 0;
        }

        .header-left p {
            font-size: 12px;
            color: #666;
            letter-spacing: 0.1em;
            margin: 4px 0 0 0;
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            padding: 8px 16px;
            background: #f7f3ed;
            color: #2a2520;
            border: 1px solid #d9d0c3;
            font-size: 11px;
            font-family: 'EB Garamond', Georgia, serif;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            margin: 0;
        }

        .header-btn:hover {
            border-color: #2a2520;
        }

        .header-btn.active {
            background: #2a2520;
            color: #f7f3ed;
            border-color: #2a2520;
        }

        .world-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 12px;
            border: 1px solid #d9d0c3;
            font-size: 11px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .world-toggle:hover {
            border-color: #2a2520;
        }

        .world-toggle input {
            appearance: none;
            width: 32px;
            height: 18px;
            background: #d9d0c3;
            border-radius: 9px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .world-toggle input::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: #f7f3ed;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .world-toggle input:checked {
            background: #2a2520;
        }

        .world-toggle input:checked::before {
            transform: translateX(14px);
        }

        .toggle-label {
            font-family: 'EB Garamond', Georgia, serif;
            color: #6b6156;
        }

        .world-toggle input:checked + .toggle-label {
            color: #2a2520;
        }

        .country-tag {
            font-size: 11px;
            color: #6b6156;
            background: #ebe5db;
            padding: 3px 8px;
            margin-left: 8px;
        }

        #list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #list-view {
            flex: 1;
            overflow-y: auto;
            background: #f7f3ed;
            padding: 0;
        }

        .list-item {
            padding: 20px 32px;
            border-bottom: 1px solid #d9d0c3;
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: #efe9e0;
        }

        .list-item h3 {
            font-size: 16px;
            font-weight: 500;
            margin: 0 0 6px 0;
        }

        .list-item .list-address {
            font-size: 13px;
            color: #6b6156;
            margin: 0 0 4px 0;
        }

        .list-item .list-hours {
            font-size: 12px;
            color: #2a2520;
            display: inline-block;
            padding: 4px 8px;
            background: #ebe5db;
            margin-top: 8px;
        }

        .list-item .list-distance {
            font-size: 12px;
            color: #6b6156;
            margin-left: 8px;
        }

        .list-item .open-now {
            font-size: 11px;
            color: #2d6a4f;
            background: #d8f3dc;
            padding: 3px 8px;
            margin-left: 8px;
            font-weight: 500;
        }

        .list-item .closed-now {
            font-size: 11px;
            color: #9d4040;
            background: #f8d7da;
            padding: 3px 8px;
            margin-left: 8px;
        }

        .popup-inner .directions-link {
            display: inline-block;
            font-size: 12px;
            color: #2a2520;
            text-decoration: none;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-bottom: 1px solid #2a2520;
            padding-bottom: 2px;
            margin-left: 16px;
        }

        .popup-inner .open-badge {
            display: inline-block;
            font-size: 11px;
            color: #2d6a4f;
            background: #d8f3dc;
            padding: 4px 10px;
            margin-bottom: 12px;
        }

        .popup-inner .closed-badge {
            display: inline-block;
            font-size: 11px;
            color: #9d4040;
            background: #f8d7da;
            padding: 4px 10px;
            margin-bottom: 12px;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            padding: 12px 32px;
            background: #efe9e0;
            border-bottom: 1px solid #d9d0c3;
        }

        .sort-btn {
            padding: 6px 12px;
            background: transparent;
            color: #6b6156;
            border: 1px solid #d9d0c3;
            font-size: 11px;
            font-family: 'EB Garamond', Georgia, serif;
            letter-spacing: 0.05em;
            cursor: pointer;
            margin: 0;
        }

        .sort-btn.active {
            background: #2a2520;
            color: #f7f3ed;
            border-color: #2a2520;
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .favorite-btn:hover {
            opacity: 0.7;
        }

        .favorite-btn.favorited {
            opacity: 1;
            color: #c44;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .popup-header h3 {
            flex: 1;
        }

        .price-tag {
            font-size: 12px;
            color: #6b6156;
            background: #ebe5db;
            padding: 3px 8px;
            margin-left: 8px;
            font-weight: 500;
        }

        .list-item .list-favorite {
            float: right;
            font-size: 18px;
            opacity: 0.3;
        }

        .list-item .list-favorite.favorited {
            opacity: 1;
            color: #c44;
        }

        .list-item .list-link {
            font-size: 11px;
            color: #2a2520;
            text-decoration: none;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-bottom: 1px solid #2a2520;
            margin-left: 12px;
        }

        .user-marker {
            width: 16px;
            height: 16px;
            background: #8b5a2b;
            border-radius: 50%;
            border: 3px solid #f7f3ed;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        #map {
            flex: 1;
            width: 100%;
            background: #ebe5db;
        }

        /* Minimal Leaflet overrides */
        .leaflet-container {
            background: #ebe5db;
            font-family: 'EB Garamond', Georgia, serif;
        }

        .leaflet-popup-content-wrapper {
            background: #f7f3ed;
            color: #2a2520;
            border-radius: 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            padding: 0;
        }

        .leaflet-popup-tip {
            background: #f7f3ed;
        }

        .leaflet-popup-close-button {
            color: #2a2520 !important;
            font-size: 20px !important;
            padding: 8px 10px !important;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 260px;
            max-width: 300px;
        }

        .popup-inner {
            padding: 20px 24px;
        }

        .popup-inner h3 {
            font-size: 18px;
            font-weight: 500;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .popup-inner .address {
            font-size: 13px;
            color: #6b6156;
            margin: 0 0 8px 0;
            line-height: 1.5;
        }

        .popup-inner .hours {
            font-size: 12px;
            color: #2a2520;
            margin: 0 0 16px 0;
            padding: 6px 10px;
            background: #ebe5db;
            display: inline-block;
        }

        .popup-inner a.website-link {
            display: inline-block;
            font-size: 12px;
            color: #2a2520;
            text-decoration: none;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-bottom: 1px solid #2a2520;
            padding-bottom: 2px;
            transition: opacity 0.2s;
        }

        .popup-inner a.website-link:hover {
            opacity: 0.6;
        }

        .notes-section {
            border-top: 1px solid #d9d0c3;
            padding: 16px 24px;
            background: #efe9e0;
        }

        .notes-section label {
            display: block;
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #6b6156;
            margin-bottom: 12px;
        }

        .notes-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .shared-note {
            padding: 10px 12px;
            background: #f7f3ed;
            margin-bottom: 8px;
            border-left: 3px solid #d9d0c3;
        }

        .shared-note .note-text {
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 6px 0;
            color: #2a2520;
        }

        .shared-note .note-meta {
            font-size: 11px;
            color: #8b8278;
            margin: 0;
            font-style: italic;
        }

        .no-notes {
            font-size: 13px;
            color: #8b8278;
            font-style: italic;
            margin: 0;
        }

        .add-note-form {
            border-top: 1px solid #d9d0c3;
            padding-top: 12px;
        }

        .author-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d0c3;
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 13px;
            background: #f7f3ed;
            margin-bottom: 8px;
        }

        .note-input {
            width: 100%;
            min-height: 60px;
            padding: 10px 12px;
            border: 1px solid #d9d0c3;
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background: #f7f3ed;
        }

        .author-input:focus,
        .note-input:focus {
            outline: none;
            border-color: #2a2520;
        }

        .notes-section .save-note {
            margin-top: 10px;
            padding: 8px 20px;
            font-size: 11px;
            background: #2a2520;
            color: #f7f3ed;
        }

        .notes-section .note-saved {
            display: none;
            margin-top: 10px;
            font-size: 12px;
            font-style: italic;
            color: #2d6a4f;
        }

        /* Leaflet controls */
        .leaflet-control-zoom a {
            background: #f7f3ed !important;
            color: #2a2520 !important;
            border: 1px solid #d9d0c3 !important;
            border-radius: 0 !important;
            width: 32px !important;
            height: 32px !important;
            line-height: 30px !important;
            font-size: 16px !important;
        }

        .leaflet-control-zoom a:hover {
            background: #ebe5db !important;
        }

        .leaflet-control-zoom {
            border: none !important;
            box-shadow: none !important;
        }

        .leaflet-control-attribution {
            background: rgba(247,243,237,0.9) !important;
            font-size: 10px;
            font-family: 'EB Garamond', Georgia, serif;
        }

        .leaflet-control-attribution a {
            color: #6b6156 !important;
        }

        /* Custom marker */
        .custom-marker {
            width: 12px;
            height: 12px;
            background: #2a2520;
            border-radius: 50%;
            border: 2px solid #f7f3ed;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        /* Add Bathhouse Button */
        #add-sauna-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: #2a2520;
            color: #f7f3ed;
            border: none;
            padding: 14px 28px;
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            z-index: 1000;
            font-family: 'EB Garamond', Georgia, serif;
            transition: background 0.2s;
        }

        #add-sauna-btn:hover {
            background: #4a4540;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(247,243,237,0.95);
            overflow-y: auto;
        }

        .modal-content {
            background: #f7f3ed;
            margin: 60px auto;
            padding: 48px;
            max-width: 520px;
            border: 1px solid #d9d0c3;
        }

        .modal-content h2 {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .modal-content > p {
            font-size: 15px;
            color: #6b6156;
            margin-bottom: 36px;
            line-height: 1.6;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: #2a2520;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.6;
        }

        .form-group {
            margin-bottom: 28px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #6b6156;
            margin-bottom: 10px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d9d0c3;
            font-size: 15px;
            font-family: 'EB Garamond', Georgia, serif;
            background: #f7f3ed;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2a2520;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.6;
        }

        .form-group small {
            display: block;
            color: #8b8278;
            margin-top: 6px;
            font-size: 13px;
            font-style: italic;
        }

        .rating-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .rating-group input[type="radio"] {
            display: none;
        }

        .rating-group label {
            padding: 8px 16px;
            border: 1px solid #d9d0c3;
            cursor: pointer;
            font-size: 14px;
            text-transform: none;
            letter-spacing: 0;
            transition: all 0.2s;
        }

        .rating-group input[type="radio"]:checked + label {
            background: #2a2520;
            color: #f7f3ed;
            border-color: #2a2520;
        }

        .rating-group label:hover {
            border-color: #2a2520;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            margin-top: 12px;
        }

        .success-message {
            background: #2a2520;
            color: #f7f3ed;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: none;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            #map-header {
                padding: 16px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            #map-header h1 {
                font-size: 12px;
            }

            #add-sauna-btn {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
            }

            .modal-content {
                margin: 20px;
                padding: 32px 24px;
            }

            #password-form {
                padding: 24px;
            }

            .rating-group {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="password-screen">
        <div id="password-form">
            <img src="https://i.pinimg.com/originals/8d/54/d2/8d54d2e33b1a851745c6db25d360a05e.jpg" alt="Shvitz" class="landing-image" />
            <h2>Shvitz Map</h2>
            <input type="password" id="password-input" placeholder="Enter password" autocomplete="off" />
            <button onclick="checkPassword()">Enter</button>
            <div class="error" id="error-message">Incorrect password</div>
        </div>
    </div>

    <!-- Map Screen -->
    <div id="map-screen">
        <div id="map-header">
            <div class="header-left">
                <h1>Shvitz Map</h1>
                <p id="bathhouse-count">40 bathhouses</p>
            </div>
            <div class="header-controls">
                <label class="world-toggle" title="Experimental: Show global bathhouses">
                    <input type="checkbox" id="world-toggle">
                    <span class="toggle-label">World</span>
                </label>
                <button id="locate-btn" class="header-btn" title="Find my location">Locate Me</button>
                <button id="map-view-btn" class="header-btn active">Map</button>
                <button id="list-view-btn" class="header-btn">List</button>
            </div>
        </div>
        <div id="map"></div>
        <div id="list-container" style="display: none;">
            <div class="sort-controls">
                <button class="sort-btn active" id="sort-alpha">A–Z</button>
                <button class="sort-btn" id="sort-distance">Nearest</button>
                <button class="sort-btn" id="sort-open">Open Now</button>
                <button class="sort-btn" id="sort-favorites">♥ Favorites</button>
            </div>
            <div id="list-view"></div>
        </div>
        <button id="add-sauna-btn">+ Add Bathhouse</button>
    </div>

    <!-- Add/Review Bathhouse Modal -->
    <div id="sauna-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add or Review a Bathhouse</h2>
            <p>Know a great bathhouse we're missing? Share it with the community.</p>

            <div id="success-msg" class="success-message">
                Thank you. Your submission has been received.
            </div>

            <form id="sauna-form">
                <div class="form-group">
                    <label for="submission-type">What would you like to do?</label>
                    <select id="submission-type" required>
                        <option value="">Select an option</option>
                        <option value="new">Add a new bathhouse</option>
                        <option value="review">Review an existing bathhouse</option>
                    </select>
                </div>

                <div class="form-group" id="sauna-select-group" style="display: none;">
                    <label for="existing-sauna">Select Bathhouse</label>
                    <select id="existing-sauna">
                        <option value="">Choose a bathhouse to review</option>
                    </select>
                </div>

                <div class="form-group" id="sauna-name-group">
                    <label for="sauna-name">Bathhouse Name</label>
                    <input type="text" id="sauna-name" required>
                </div>

                <div class="form-group" id="sauna-address-group">
                    <label for="sauna-address">Address</label>
                    <input type="text" id="sauna-address" placeholder="Full street address with postcode" required>
                </div>

                <div class="form-group" id="sauna-website-group">
                    <label for="sauna-website">Website</label>
                    <input type="url" id="sauna-website" placeholder="https://">
                </div>

                <div class="form-group">
                    <label>Rating</label>
                    <div class="rating-group">
                        <input type="radio" name="rating" id="rating-1" value="1">
                        <label for="rating-1">1</label>
                        <input type="radio" name="rating" id="rating-2" value="2">
                        <label for="rating-2">2</label>
                        <input type="radio" name="rating" id="rating-3" value="3">
                        <label for="rating-3">3</label>
                        <input type="radio" name="rating" id="rating-4" value="4">
                        <label for="rating-4">4</label>
                        <input type="radio" name="rating" id="rating-5" value="5">
                        <label for="rating-5">5</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="review-text">Your Review</label>
                    <textarea id="review-text" placeholder="Tell us about your experience..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="reviewer-name">Your Name</label>
                    <input type="text" id="reviewer-name" placeholder="Anonymous">
                </div>

                <div class="form-group">
                    <label for="reviewer-email">Your Email</label>
                    <input type="email" id="reviewer-email" placeholder="For follow-up only">
                    <small>We'll only use this to contact you about your submission</small>
                </div>

                <button type="submit" class="submit-btn">Submit</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        // Password hash (SHA-256 of 'shvitz')
        const PASSWORD_HASH = 'ebbfe519cebbbb572da632ae0263eeac94b828b4e27a3e55f271242060580df6';

        // Sauna data
        const saunaData = [
            {"name": "ARC", "address": "Minus Level 2, 1 Crossrail Place, Canary Wharf, London E14 5AR", "lat": 51.5048954, "lon": -0.0190006, "website": "https://www.arc-community.com/", "hours": "Daily, session-based booking", "price": "£££"},
            {"name": "Banya No.1 Chiswick", "address": "404-406 Chiswick High Road, London W4 5TF", "lat": 51.4923137, "lon": -0.263818, "website": "https://gobanyachiswick.co.uk/", "hours": "Daily 9:30am–10:30pm", "price": "£££"},
            {"name": "Banya No.1 Hoxton", "address": "17 Micawber Street, London N1 7TB", "lat": 51.5323935, "lon": -0.086078, "website": "https://gobanya.co.uk/", "hours": "Daily 9:30am–10:30pm", "price": "£££"},
            {"name": "BlocFit Climbing Wall", "address": "Arch 266, 241 Coldharbour Lane, London SW9 8RR", "lat": 51.4662551, "lon": -0.1021612, "website": "https://www.blocfit.co.uk/", "hours": "Daily, check website for times", "price": "££"},
            {"name": "Blok Hot+Cold", "address": "Unit UJ5, The Tram Depot, 38-40 Upper Clapton Road, London E5 8BQ", "lat": 51.558602, "lon": -0.0558777, "website": "https://www.bloklondon.com/hotcold", "hours": "Mon–Fri 6am–9:30pm, Sat 8:30am–6pm, Sun 9am–5:30pm", "price": "££"},
            {"name": "Community Sauna Baths, Camberwell", "address": "Ruskin Park, Denmark Hill, London SE5 9AW", "lat": 51.4745706, "lon": -0.0925416, "website": "https://www.community-sauna.co.uk/", "hours": "Daily 7am–9:30pm", "price": "£"},
            {"name": "Community Sauna Baths, Hackney", "address": "The Baths 80, Eastway, London E9 5JH", "lat": 51.5434383, "lon": -0.0241542, "website": "https://www.community-sauna.co.uk/", "hours": "Daily 8am–9:30pm", "price": "£"},
            {"name": "Community Sauna Baths, Peckham", "address": "64 Glengall Road, Glengall Wharf Garden, Burgess Park, London SE15 6NH", "lat": 51.4734122, "lon": -0.0699321, "website": "https://www.community-sauna.co.uk/", "hours": "Daily 7am–9:30pm", "price": "£"},
            {"name": "Community Sauna Baths, Stratford", "address": "Stratford, London E15", "lat": 51.541289, "lon": -0.0035472, "website": "https://www.community-sauna.co.uk/", "hours": "Daily 7am–9:30pm", "price": "£"},
            {"name": "Community Sauna Baths, Walthamstow", "address": "Walthamstow, London E17", "lat": 51.5844701, "lon": -0.0188186, "website": "https://www.community-sauna.co.uk/", "hours": "Daily 7am–9:30pm", "price": "£"},
            {"name": "Contrast Anerley", "address": "Unit 106, 183A Anerley Road, London SE20 8EF", "lat": 51.4088267, "lon": -0.0611263, "website": "https://www.contrastlondon.co.uk/", "hours": "By appointment, book 6hrs ahead", "price": "££"},
            {"name": "Drip Sauna", "address": "Coaling Jetty, Battersea Power Station, London SW11 8BZ", "lat": 51.4707933, "lon": -0.172214, "website": "https://www.dripsauna.co.uk/", "hours": "Daily, session-based booking", "price": "£££"},
            {"name": "Finnish Church in London", "address": "33 Albion Street, Rotherhithe, London SE16 7HZ", "lat": 51.5002908, "lon": -0.0436321, "website": "https://britannia.merimieskirkko.fi/en/", "hours": "Wed–Sun, check website", "price": "£"},
            {"name": "Hot & Cold UK", "address": "662 High Road Leytonstone, London E11 3AA", "lat": 51.5683955, "lon": 0.0111704, "website": "https://hotandcoldonline.co.uk/", "hours": "Daily 6am–9pm", "price": "££"},
            {"name": "Innervisions Alchemy", "address": "Rollins Street, London SE15 1EP", "lat": 51.4970125, "lon": -0.063268, "website": "https://www.innervisionsalchemy.co.uk/", "hours": "Check website", "price": "££"},
            {"name": "Little Healing", "address": "1 New Mount Court, Julien Road, London W5 4XA", "lat": 51.5126553, "lon": -0.3051952, "website": "https://www.littlehealing.co.uk/", "hours": "By appointment, 45-min sessions", "price": "££"},
            {"name": "LoWLU, Kentish Town", "address": "Caversham Road, Kentish Town, London NW5", "lat": 51.5500554, "lon": -0.1425712, "website": "https://www.lowlu.co/", "hours": "Daily 7am–9pm", "price": "££"},
            {"name": "LoWLU, Wandsworth", "address": "Wandsworth, London SW18", "lat": 51.4570271, "lon": -0.1932607, "website": "https://www.lowlu.co/", "hours": "Daily 6am–9pm", "price": "££"},
            {"name": "Mile End Climbing Wall", "address": "Haverfield Road, Mile End Park, London E3 5BE", "lat": 51.5253378, "lon": -0.033435, "website": "https://www.mileendwall.org.uk/", "hours": "Mon–Fri 7am–10pm, Sat–Sun 9am–8pm", "price": "£"},
            {"name": "New Docklands Steam Baths", "address": "30a Stephenson Street, Canning Town, London E16 4SA", "lat": 51.5139887, "lon": 0.0082987, "website": "https://newdocklands.uk/", "hours": "Tue–Sun, varies by day", "price": "£"},
            {"name": "Old Kent Road Sauna", "address": "Old Kent Road, London SE15", "lat": 51.4752983, "lon": -0.0404289, "website": "https://www.oldkentroadsauna.com/", "hours": "Check website", "price": "££"},
            {"name": "Porchester Spa", "address": "Porchester Centre, Porchester Road, Queensway, London W2 5HS", "lat": 51.5122764, "lon": -0.1883854, "website": "https://www.porchesterspatreatments.co.uk/", "hours": "Mon–Fri 10am–9:30pm, Sat–Sun 10am–8pm", "price": "£"},
            {"name": "Putney Recovery Room", "address": "Putney, London SW15", "lat": 51.4625314, "lon": -0.2163018, "website": "https://www.putneyrecovery.com/", "hours": "Check website", "price": "££"},
            {"name": "Rebase", "address": "1a St Vincent Street, Marylebone, London W1U 4DA", "lat": 51.5196374, "lon": -0.1519627, "website": "https://www.rebaserecovery.com/", "hours": "Mon–Fri 7am–9pm, Sat–Sun 8am–8pm", "price": "£££"},
            {"name": "Revitalise Urban Spa", "address": "2 Maple Path, Lower Clapton, London E5 8FD", "lat": 51.5546565, "lon": -0.0550912, "website": "https://www.revitaliseurbanspa.co.uk/", "hours": "Check website", "price": "££"},
            {"name": "Rooftop Saunas, Brixton", "address": "International House, 11th Floor, Brixton, London SW9", "lat": 51.4633914, "lon": -0.1148023, "website": "https://rooftopsaunas.com/", "hours": "Mon–Sat 8am–10:20pm, Sun 9am–7:40pm", "price": "££"},
            {"name": "Rooftop Saunas, Hackney", "address": "Netil Corner, 2 Bocking Street, London E8 4RU", "lat": 51.5432402, "lon": -0.0493621, "website": "https://rooftopsaunas.com/", "hours": "Mon–Sat 7:30am–10:20pm, Sun 10am–7:50pm", "price": "££"},
            {"name": "Sauna & Plunge", "address": "124 Tabernacle Street, Shoreditch, London EC2A 4SA", "lat": 51.5266694, "lon": -0.0798926, "website": "https://saunaandplunge.life/", "hours": "Daily 6:30am–8pm", "price": "££"},
            {"name": "Sauna Social Club", "address": "Railway Arch 842, Brayards Road, Peckham, London SE15 2AG", "lat": 51.4734122, "lon": -0.0699321, "website": "https://www.saunasocialclub.co.uk/", "hours": "Wed–Sun, session-based", "price": "££"},
            {"name": "Saunos", "address": "49-50 Eagle Wharf Road, London N1 7ED", "lat": 51.5323935, "lon": -0.086078, "website": "https://www.legitfit.com/p/timetable/saunoslimited", "hours": "Check website for sessions", "price": "££"},
            {"name": "Skuna Sauna, London", "address": "West India Quay, Hertsmere Road, Canary Wharf, London E14 4AL", "lat": 51.5048954, "lon": -0.0190006, "website": "https://www.skunasauna.com/", "hours": "Mon–Fri 12pm–9pm, Sat–Sun 10am–9pm", "price": "£££"},
            {"name": "Stoke Newington Sauna", "address": "129 Stoke Newington High St, London N16 0PH", "lat": 51.5578698, "lon": -0.0822482, "website": "https://stokenewingtonsauna.com/", "hours": "Check website", "price": "££"},
            {"name": "SweHeat Sauna", "address": "1 Dock Rd, Royal Victoria Dock, London E16 1AH", "lat": 51.5078, "lon": 0.0178, "website": "https://www.sweheatsauna.co.uk/", "hours": "Check website", "price": "££"},
            {"name": "Temz Floating Saunas", "address": "The Lensbury, Broom Road, Teddington, London TW11 9NU", "lat": 51.4277844, "lon": -0.333653, "website": "https://www.temzfloatingsaunas.com/", "hours": "By appointment, 50-min sessions", "price": "£££"},
            {"name": "The Bath House", "address": "1 Grosvenor Gardens, Belgravia, London SW1W 0BD", "lat": 51.4982128, "lon": -0.1534998, "website": "https://banyalondon.co.uk/", "hours": "Mon–Sat 10am–11pm, Sun 10am–10pm", "price": "£££"},
            {"name": "The Cabin Sauna", "address": "Clapham Common, London SW4", "lat": 51.4614469, "lon": -0.138627, "website": "https://thecabinsauna.co.uk/", "hours": "Seasonal (Oct–May), check website", "price": "££"},
            {"name": "The Sanctuary at &Soul", "address": "114 Cheshire Street, London E2 6EJ", "lat": 51.5225, "lon": -0.0665, "website": "https://andsoul.com/locations/shoreditch/the-sanctuary", "hours": "Check website", "price": "£££"},
            {"name": "Urban Heat Sauna", "address": "347 Camberwell Station Road, London SE5 9JN", "lat": 51.4683, "lon": -0.0912, "website": "https://www.urbanheatwellness.com/", "hours": "Check website", "price": "££"},
            {"name": "WellNest", "address": "7 Crucifix Lane, London Bridge, London SE1 3JW", "lat": 51.5061349, "lon": -0.1011379, "website": "https://www.wellnest.london/", "hours": "Mon–Fri 7am–10pm, Sat 9am–6pm, Sun 10am–5pm", "price": "££"}
        ];

        // World bathhouse data (experimental) - 118 locations
        const worldData = [
            // FINLAND
            {"name": "Rajaportin Sauna", "address": "Pispalan valtatie 9, Tampere", "lat": 61.4978, "lon": 23.7419, "website": "https://rajaportinsauna.fi/", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Kotiharju Sauna", "address": "Harjutorinkatu 1, Helsinki", "lat": 60.1867, "lon": 24.9526, "website": "https://www.kotiharjunsauna.fi/", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Löyly Helsinki", "address": "Hernesaarenranta 4, Helsinki", "lat": 60.1534, "lon": 24.9213, "website": "https://www.loylyhelsinki.fi/", "country": "Finland", "type": "Sauna", "price": "££"},
            {"name": "SompaSauna", "address": "Sompasaari, Helsinki", "lat": 60.1889, "lon": 24.9786, "website": "", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Finnish Sauna Society", "address": "Vaskiniementie 10, Helsinki", "lat": 60.1548, "lon": 24.8697, "website": "https://sauna.fi/en/", "country": "Finland", "type": "Sauna", "price": "££"},
            {"name": "Rauhaniemi Folk Spa", "address": "Rauhaniemi, Tampere", "lat": 61.5088, "lon": 23.7506, "website": "", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Sauna Hermanni", "address": "Hämeentie 63, Helsinki", "lat": 60.1934, "lon": 24.9678, "website": "https://saunahermanni.fi/", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Kulttuurisauna", "address": "Hakaniemenranta 17, Helsinki", "lat": 60.1850, "lon": 24.9890, "website": "https://www.kulttuurisauna.fi/", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Lähteen Sauna", "address": "Helsinki", "lat": 60.1699, "lon": 24.9384, "website": "", "country": "Finland", "type": "Sauna", "price": "£"},
            {"name": "Ring Spa & Saunas", "address": "Oulu", "lat": 65.0121, "lon": 25.4651, "website": "", "country": "Finland", "type": "Sauna", "price": "££"},
            // ESTONIA
            {"name": "Mooska Smoke Sauna", "address": "Mooska küla, Võrumaa", "lat": 57.8431, "lon": 26.9686, "website": "http://mooska.eu/", "country": "Estonia", "type": "SmokeSauna", "price": "££"},
            {"name": "Iglupark", "address": "Pirita tee, Tallinn", "lat": 59.4370, "lon": 24.7536, "website": "https://iglupark.ee/", "country": "Estonia", "type": "Sauna", "price": "££"},
            {"name": "Mustjõe Kõrtsitalu", "address": "Võrumaa", "lat": 57.8500, "lon": 27.0000, "website": "", "country": "Estonia", "type": "SmokeSauna", "price": "££"},
            {"name": "Sauna Village", "address": "Mooste, Põlvamaa", "lat": 58.1167, "lon": 27.1667, "website": "", "country": "Estonia", "type": "SmokeSauna", "price": "££"},
            {"name": "Saunamaa Võrumaal", "address": "Võrumaa", "lat": 57.8333, "lon": 27.0167, "website": "", "country": "Estonia", "type": "SmokeSauna", "price": "££"},
            {"name": "Pätsuloigu Puhketalu", "address": "Võrumaa", "lat": 57.8200, "lon": 26.9500, "website": "", "country": "Estonia", "type": "SmokeSauna", "price": "££"},
            {"name": "Kalma Saun", "address": "Tallinn", "lat": 59.4370, "lon": 24.7453, "website": "", "country": "Estonia", "type": "Sauna", "price": "£"},
            {"name": "Leilisaun", "address": "Tallinn", "lat": 59.4300, "lon": 24.7500, "website": "", "country": "Estonia", "type": "Sauna", "price": "£"},
            {"name": "Heldeke!", "address": "Tallinn", "lat": 59.4388, "lon": 24.7545, "website": "", "country": "Estonia", "type": "Sauna", "price": "££"},
            // SWEDEN
            {"name": "Sthlm Sauna Vinterviken", "address": "Vinterviken, Stockholm", "lat": 59.3193, "lon": 18.0686, "website": "", "country": "Sweden", "type": "Sauna", "price": "£"},
            {"name": "Hellasgården", "address": "Nacka", "lat": 59.2984, "lon": 18.1667, "website": "https://hellasgarden.se/", "country": "Sweden", "type": "Sauna", "price": "£"},
            {"name": "Tantobastun", "address": "Tantolunden, Stockholm", "lat": 59.3120, "lon": 18.0381, "website": "https://www.tantobastuforening.se/", "country": "Sweden", "type": "Sauna", "price": "£"},
            {"name": "Centralbadet", "address": "Drottninggatan 88, Stockholm", "lat": 59.3370, "lon": 18.0600, "website": "https://centralbadet.se/", "country": "Sweden", "type": "Spa", "price": "£££"},
            {"name": "Bastuflotten ReLaxa", "address": "Stockholm", "lat": 59.3293, "lon": 18.0686, "website": "", "country": "Sweden", "type": "Sauna", "price": "££"},
            {"name": "Skeppsudden", "address": "Stockholm Archipelago", "lat": 59.3500, "lon": 18.2000, "website": "", "country": "Sweden", "type": "Sauna", "price": "££"},
            {"name": "The Nest (Downtown Camper)", "address": "Stockholm", "lat": 59.3326, "lon": 18.0649, "website": "", "country": "Sweden", "type": "Sauna", "price": "££"},
            {"name": "Sauna Radio", "address": "Smedsuddsvägen 23, Stockholm", "lat": 59.3300, "lon": 18.0100, "website": "", "country": "Sweden", "type": "Sauna", "price": "£"},
            // NORWAY
            {"name": "Oslo Badstuforening", "address": "Langkaia, Oslo", "lat": 59.9070, "lon": 10.7489, "website": "", "country": "Norway", "type": "Sauna", "price": "£"},
            {"name": "SALT", "address": "Langkaia 1, Oslo", "lat": 59.9067, "lon": 10.7478, "website": "https://salted.no/", "country": "Norway", "type": "Sauna", "price": "££"},
            {"name": "Sagene Public Bath", "address": "Sagene, Oslo", "lat": 59.9400, "lon": 10.7500, "website": "", "country": "Norway", "type": "Sauna", "price": "£"},
            // TURKEY
            {"name": "Çağaloğlu Hamamı", "address": "Alemdar, Istanbul", "lat": 41.0082, "lon": 28.9784, "website": "https://cagalogluhamami.com.tr/", "country": "Turkey", "type": "Hammam", "price": "£££"},
            {"name": "Kılıç Ali Paşa Hamamı", "address": "Kemankeş, Istanbul", "lat": 41.0256, "lon": 28.9813, "website": "https://kilicalipasahamami.com/", "country": "Turkey", "type": "Hammam", "price": "£££"},
            {"name": "Çemberlitaş Hamamı", "address": "Çemberlitaş, Istanbul", "lat": 41.0082, "lon": 28.9713, "website": "https://www.cemberlitashamami.com/", "country": "Turkey", "type": "Hammam", "price": "££"},
            {"name": "Ayasofya Hürrem Sultan Hamamı", "address": "Sultanahmet, Istanbul", "lat": 41.0054, "lon": 28.9768, "website": "https://www.ayasofyahamami.com/", "country": "Turkey", "type": "Hammam", "price": "£££"},
            {"name": "Süleymaniye Hamamı", "address": "Süleymaniye, Istanbul", "lat": 41.0164, "lon": 28.9639, "website": "", "country": "Turkey", "type": "Hammam", "price": "££"},
            {"name": "Zeyrek Çinili Hamam", "address": "Zeyrek, Istanbul", "lat": 41.0200, "lon": 28.9550, "website": "", "country": "Turkey", "type": "Hammam", "price": "££"},
            {"name": "Ağa Hamamı", "address": "Cihangir, Istanbul", "lat": 41.0300, "lon": 28.9850, "website": "", "country": "Turkey", "type": "Hammam", "price": "££"},
            {"name": "Çukurcuma Hamamı", "address": "Çukurcuma, Istanbul", "lat": 41.0320, "lon": 28.9800, "website": "", "country": "Turkey", "type": "Hammam", "price": "££"},
            // JAPAN
            {"name": "Takaragawa Onsen", "address": "Minakami, Gunma", "lat": 36.7833, "lon": 139.0167, "website": "https://www.takaragawa.com/", "country": "Japan", "type": "Onsen", "price": "£££"},
            {"name": "Nyuto Onsen", "address": "Semboku, Akita", "lat": 39.7833, "lon": 140.7833, "website": "", "country": "Japan", "type": "Onsen", "price": "££"},
            {"name": "Hoshi Onsen Chojukan", "address": "Minakami, Gunma", "lat": 36.7500, "lon": 138.7833, "website": "https://www.hoshi-onsen.com/", "country": "Japan", "type": "Onsen", "price": "£££"},
            {"name": "Sekizenkan", "address": "Shima Onsen, Gunma", "lat": 36.6500, "lon": 138.7833, "website": "https://www.sekizenkan.co.jp/", "country": "Japan", "type": "Onsen", "price": "£££"},
            {"name": "Dogo Onsen", "address": "Matsuyama, Ehime", "lat": 33.8512, "lon": 132.7852, "website": "https://dogo.jp/", "country": "Japan", "type": "Onsen", "price": "£"},
            {"name": "Kurokawa Onsen", "address": "Minamioguni, Kumamoto", "lat": 33.1000, "lon": 131.2167, "website": "", "country": "Japan", "type": "Onsen", "price": "££"},
            {"name": "LaQua", "address": "Tokyo Dome City, Tokyo", "lat": 35.7057, "lon": 139.7537, "website": "https://en.www.laqua.jp/spa/", "country": "Japan", "type": "Onsen", "price": "££"},
            {"name": "Tenzan no Yu", "address": "Hakone, Kanagawa", "lat": 35.2333, "lon": 139.0667, "website": "", "country": "Japan", "type": "Onsen", "price": "££"},
            {"name": "Koganeyu", "address": "Sumida, Tokyo", "lat": 35.7100, "lon": 139.8100, "website": "", "country": "Japan", "type": "Sento", "price": "£"},
            {"name": "Takarayu", "address": "Tokyo", "lat": 35.6895, "lon": 139.6917, "website": "", "country": "Japan", "type": "Sento", "price": "£"},
            {"name": "Myōjin-yu", "address": "Tokyo", "lat": 35.7000, "lon": 139.7700, "website": "", "country": "Japan", "type": "Sento", "price": "£"},
            {"name": "Azabu Kokubisui Hot Spring Takenoyu", "address": "Minato, Tokyo", "lat": 35.6544, "lon": 139.7379, "website": "", "country": "Japan", "type": "Onsen", "price": "££"},
            {"name": "TSUKAHARA KARAFURO", "address": "Beppu, Oita", "lat": 33.2800, "lon": 131.5000, "website": "", "country": "Japan", "type": "Onsen", "price": "£"},
            {"name": "Kitakobushi Shiretoko Hotel & Resort", "address": "Shiretoko, Hokkaido", "lat": 44.0700, "lon": 145.0500, "website": "", "country": "Japan", "type": "Onsen", "price": "£££"},
            {"name": "Ohya Genki-ro No.06 AZUMAYA", "address": "Gunma", "lat": 36.5000, "lon": 139.0000, "website": "", "country": "Japan", "type": "Onsen", "price": "££"},
            // RUSSIA
            {"name": "Sanduny Banya", "address": "Neglinnaya 14, Moscow", "lat": 55.7642, "lon": 37.6214, "website": "https://sanduny.ru/", "country": "Russia", "type": "Banya", "price": "££"},
            // GERMANY
            {"name": "Vabali Spa Berlin", "address": "Seydlitzstraße 6, Berlin", "lat": 52.5256, "lon": 13.3667, "website": "https://www.vabali.de/", "country": "Germany", "type": "Spa", "price": "££"},
            {"name": "Liquidrom", "address": "Möckernstraße 10, Berlin", "lat": 52.4981, "lon": 13.3811, "website": "https://liquidrom-berlin.de/", "country": "Germany", "type": "Spa", "price": "££"},
            {"name": "Friedrichsbad Baden-Baden", "address": "Römerplatz 1, Baden-Baden", "lat": 48.7629, "lon": 8.2423, "website": "https://friedrichsbad.net/", "country": "Germany", "type": "Spa", "price": "£££"},
            {"name": "Neptunbad Sports & Spa", "address": "Neptunplatz 1, Cologne", "lat": 50.9500, "lon": 6.9167, "website": "", "country": "Germany", "type": "Spa", "price": "££"},
            {"name": "Vabali Spa Düsseldorf", "address": "Düsseldorf", "lat": 51.2277, "lon": 6.7735, "website": "https://www.vabali.de/", "country": "Germany", "type": "Spa", "price": "££"},
            {"name": "Alte Muehle", "address": "Germany", "lat": 50.0000, "lon": 8.0000, "website": "", "country": "Germany", "type": "Sauna", "price": "££"},
            // USA
            {"name": "Russian & Turkish Baths", "address": "268 E 10th St, New York", "lat": 40.7282, "lon": -73.9835, "website": "https://www.russianturkishbaths.com/", "country": "USA", "type": "Banya", "price": "££"},
            {"name": "Bathhouse Flatiron", "address": "14 W 22nd St, New York", "lat": 40.7411, "lon": -73.9920, "website": "https://www.abathhouse.com/flatiron", "country": "USA", "type": "Spa", "price": "£££"},
            {"name": "Othership Flatiron", "address": "23 W 20th St, New York", "lat": 40.7402, "lon": -73.9929, "website": "https://www.othership.us/flatiron", "country": "USA", "type": "Sauna", "price": "££"},
            {"name": "BATHHOUSE Williamsburg", "address": "103 N 10th St, Brooklyn", "lat": 40.7200, "lon": -73.9600, "website": "https://www.abathhouse.com/", "country": "USA", "type": "Spa", "price": "£££"},
            {"name": "cityWell Brooklyn", "address": "496 President St, Brooklyn", "lat": 40.6799, "lon": -73.9858, "website": "https://citywellbrooklyn.com/", "country": "USA", "type": "Spa", "price": "££"},
            {"name": "Wall Street Bath & Spa 88", "address": "88 Fulton St, New York", "lat": 40.7094, "lon": -74.0042, "website": "", "country": "USA", "type": "Spa", "price": "££"},
            {"name": "WORLD SPA", "address": "Brooklyn, New York", "lat": 40.5900, "lon": -73.9500, "website": "", "country": "USA", "type": "Spa", "price": "££"},
            {"name": "Dillon's Russian Steam Bath", "address": "Brooklyn, New York", "lat": 40.6200, "lon": -73.9700, "website": "", "country": "USA", "type": "Banya", "price": "£"},
            {"name": "Archimedes Banya", "address": "748 Innes Ave, San Francisco", "lat": 37.7305, "lon": -122.3728, "website": "https://banyasf.com/", "country": "USA", "type": "Banya", "price": "££"},
            {"name": "Kabuki Springs & Spa", "address": "1750 Geary Blvd, San Francisco", "lat": 37.7850, "lon": -122.4294, "website": "", "country": "USA", "type": "Spa", "price": "££"},
            {"name": "Onsen", "address": "San Francisco", "lat": 37.7700, "lon": -122.4200, "website": "", "country": "USA", "type": "Onsen", "price": "££"},
            {"name": "Alchemy Springs & Sauna Garden", "address": "San Francisco", "lat": 37.7600, "lon": -122.4100, "website": "", "country": "USA", "type": "Sauna", "price": "££"},
            {"name": "Bathhouse Chicago", "address": "1369 W Erie St, Chicago", "lat": 41.8940, "lon": -87.6633, "website": "https://www.bathhousechicago.com/", "country": "USA", "type": "Sauna", "price": "££"},
            {"name": "Ojo Caliente Mineral Springs", "address": "50 Los Banos Dr, Ojo Caliente, NM", "lat": 36.3031, "lon": -106.0467, "website": "https://ojosparesorts.com/", "country": "USA", "type": "HotSpring", "price": "££"},
            {"name": "Riverbend Hot Springs", "address": "Truth or Consequences, NM", "lat": 33.1284, "lon": -107.2528, "website": "", "country": "USA", "type": "HotSpring", "price": "££"},
            {"name": "Jemez Hot Springs", "address": "Jemez Springs, NM", "lat": 35.7722, "lon": -106.6911, "website": "", "country": "USA", "type": "HotSpring", "price": "££"},
            {"name": "AetherHaus", "address": "USA", "lat": 34.0522, "lon": -118.2437, "website": "", "country": "USA", "type": "Sauna", "price": "££"},
            {"name": "Ellery Beach House", "address": "USA", "lat": 34.0000, "lon": -118.5000, "website": "", "country": "USA", "type": "Sauna", "price": "££"},
            {"name": "Infinit Sen", "address": "USA", "lat": 40.7500, "lon": -74.0000, "website": "", "country": "USA", "type": "Spa", "price": "££"},
            {"name": "Kelo Spa", "address": "USA", "lat": 40.7000, "lon": -74.0000, "website": "", "country": "USA", "type": "Spa", "price": "££"},
            // CANADA
            {"name": "Nordik Spa-Nature", "address": "16 Chemin Nordik, Chelsea, QC", "lat": 45.5047, "lon": -75.7872, "website": "https://chelsea.lenordik.com/", "country": "Canada", "type": "Spa", "price": "££"},
            // UK (non-London)
            {"name": "AIRE Ancient Baths London", "address": "2-3 Robert St, London", "lat": 51.5089, "lon": -0.1227, "website": "https://beaire.com/en/aire-ancient-baths-london", "country": "UK", "type": "Spa", "price": "£££"},
            {"name": "Galgorm", "address": "Ballymena, Northern Ireland", "lat": 54.8756, "lon": -6.3428, "website": "https://www.galgorm.com/", "country": "UK", "type": "Spa", "price": "£££"},
            {"name": "Kilcullens Seaweed Baths", "address": "Enniscrone, Ireland", "lat": 54.2167, "lon": -9.1000, "website": "", "country": "Ireland", "type": "Spa", "price": "££"},
            // AUSTRIA
            {"name": "Aqua Dome", "address": "Oberlagenfeld 140, Längenfeld", "lat": 47.0685, "lon": 10.9656, "website": "https://www.aqua-dome.at/", "country": "Austria", "type": "Spa", "price": "£££"},
            {"name": "Amalienbad", "address": "Reumannplatz, Vienna", "lat": 48.1750, "lon": 16.3800, "website": "", "country": "Austria", "type": "Spa", "price": "£"},
            {"name": "Hermannbad", "address": "Vienna", "lat": 48.2082, "lon": 16.3738, "website": "", "country": "Austria", "type": "Spa", "price": "£"},
            {"name": "Taiga Spa", "address": "Austria", "lat": 47.2692, "lon": 11.4041, "website": "", "country": "Austria", "type": "Spa", "price": "££"},
            // ITALY
            {"name": "Terme di Castrocaro", "address": "Castrocaro Terme, Italy", "lat": 44.1667, "lon": 11.9500, "website": "", "country": "Italy", "type": "Spa", "price": "££"},
            {"name": "QC San Pellegrino Terme", "address": "San Pellegrino Terme", "lat": 45.8333, "lon": 9.6667, "website": "", "country": "Italy", "type": "Spa", "price": "£££"},
            {"name": "Alpin Panorama Hotel Hubertus", "address": "South Tyrol", "lat": 46.7500, "lon": 11.9500, "website": "", "country": "Italy", "type": "Spa", "price": "£££"},
            // NETHERLANDS
            {"name": "Thermen Bussloo", "address": "Bussloo, Netherlands", "lat": 52.2500, "lon": 6.1000, "website": "", "country": "Netherlands", "type": "Spa", "price": "££"},
            {"name": "Sauna Deco", "address": "Amsterdam", "lat": 52.3676, "lon": 4.9041, "website": "", "country": "Netherlands", "type": "Sauna", "price": "££"},
            // PORTUGAL
            {"name": "Corinthia Lisbon", "address": "Lisbon", "lat": 38.7436, "lon": -9.1602, "website": "", "country": "Portugal", "type": "Spa", "price": "£££"},
            {"name": "Leela Lisboa", "address": "Lisbon", "lat": 38.7200, "lon": -9.1500, "website": "", "country": "Portugal", "type": "Spa", "price": "££"},
            {"name": "Healthy Horizon Lisbon", "address": "Lisbon", "lat": 38.7100, "lon": -9.1400, "website": "", "country": "Portugal", "type": "Spa", "price": "££"},
            {"name": "Doria Center Fitness Club", "address": "Lisbon", "lat": 38.7300, "lon": -9.1500, "website": "", "country": "Portugal", "type": "Gym", "price": "££"},
            // GEORGIA
            {"name": "Chreli Abano", "address": "Abano St, Tbilisi", "lat": 41.6884, "lon": 44.8092, "website": "https://chreli-abano.ge/", "country": "Georgia", "type": "Hammam", "price": "£"},
            {"name": "Gulo's Thermal Spa", "address": "Abanotubani, Tbilisi", "lat": 41.6880, "lon": 44.8090, "website": "", "country": "Georgia", "type": "Hammam", "price": "£"},
            {"name": "Banya No.1 - Tbilisi", "address": "Tbilisi", "lat": 41.6938, "lon": 44.8015, "website": "", "country": "Georgia", "type": "Banya", "price": "££"},
            // MOROCCO
            {"name": "Hammam de la Rose", "address": "130 Dar el Bacha, Marrakech", "lat": 31.6350, "lon": -7.9900, "website": "https://hammamdelarose.com/", "country": "Morocco", "type": "Hammam", "price": "££"},
            {"name": "Medina Hammam Center", "address": "Marrakech", "lat": 31.6295, "lon": -7.9811, "website": "", "country": "Morocco", "type": "Hammam", "price": "£"},
            {"name": "Hammam Bains Vapeurs", "address": "Marrakech", "lat": 31.6300, "lon": -7.9800, "website": "", "country": "Morocco", "type": "Hammam", "price": "£"},
            // KOREA
            {"name": "Dragon Hill Spa", "address": "Yongsan-gu, Seoul", "lat": 37.5289, "lon": 126.9653, "website": "", "country": "Korea", "type": "Jjimjilbang", "price": "£"},
            {"name": "Siloam Sauna", "address": "Jungnim-ro, Seoul", "lat": 37.5531, "lon": 126.9683, "website": "", "country": "Korea", "type": "Jjimjilbang", "price": "£"},
            // MEXICO
            {"name": "Koti Casa Condesa", "address": "Av. Veracruz 73, Condesa, Mexico City", "lat": 19.4133, "lon": -99.1733, "website": "https://www.kotiwellness.com/", "country": "Mexico", "type": "Sauna", "price": "££"},
            // UKRAINE
            {"name": "Олексіївські бані", "address": "Kharkiv, Ukraine", "lat": 49.9935, "lon": 36.2304, "website": "", "country": "Ukraine", "type": "Banya", "price": "£"},
            {"name": "Banya Na Dnipri", "address": "Kyiv, Ukraine", "lat": 50.4501, "lon": 30.5234, "website": "", "country": "Ukraine", "type": "Banya", "price": "£"},
            // MISC
            {"name": "The Hot Cold Club", "address": "Lisbon", "lat": 38.7223, "lon": -9.1393, "website": "", "country": "Portugal", "type": "Cafe", "price": "£"},
            {"name": "aimara.studio", "address": "Lisbon", "lat": 38.7200, "lon": -9.1400, "website": "", "country": "Portugal", "type": "Wellness", "price": "££"},
            {"name": "Gather", "address": "London", "lat": 51.5300, "lon": -0.1000, "website": "", "country": "UK", "type": "Restaurant", "price": "££"},
            {"name": "The Base Club", "address": "UK", "lat": 51.5074, "lon": -0.1278, "website": "", "country": "UK", "type": "Wellness", "price": "££"},
            {"name": "Bear and Birch", "address": "UK", "lat": 51.5000, "lon": -0.1000, "website": "", "country": "UK", "type": "Sauna", "price": "££"},
            {"name": "Banya Forrest", "address": "UK", "lat": 51.5000, "lon": -0.1500, "website": "", "country": "UK", "type": "Banya", "price": "££"},
            {"name": "TEPLO CONCEPT", "address": "Europe", "lat": 52.5200, "lon": 13.4050, "website": "", "country": "Germany", "type": "Sauna", "price": "££"},
            {"name": "The Banya", "address": "Europe", "lat": 52.0000, "lon": 4.0000, "website": "", "country": "Netherlands", "type": "Banya", "price": "££"},
            {"name": "Fjord", "address": "London", "lat": 51.5200, "lon": -0.0800, "website": "", "country": "UK", "type": "Sauna", "price": "££"},
            {"name": "Pearl Spa and Sauna", "address": "London", "lat": 51.5100, "lon": -0.1000, "website": "", "country": "UK", "type": "Spa", "price": "££"},
            {"name": "Spa Experience Old Street", "address": "Old Street, London", "lat": 51.5263, "lon": -0.0875, "website": "", "country": "UK", "type": "Spa", "price": "££"},
            {"name": "Saunos", "address": "Eagle Wharf Road, London", "lat": 51.5324, "lon": -0.0861, "website": "", "country": "UK", "type": "Sauna", "price": "££"}
        ];

        // Current view mode
        let worldMode = false;

        // Supabase client (loaded lazily)
        const SUPABASE_URL = 'https://bamntpbsixmshkhqpaov.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbW50cGJzaXhtc2hraHFwYW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMjYyMTgsImV4cCI6MjA4NjkwMjIxOH0.dx02LhgYgOXwrSD7_IKtqXXYwL6DEUHa38ezX1uqRSs';
        let supabase = null;
        let supabaseLoaded = false;

        async function loadSupabase() {
            if (supabaseLoaded) return;
            supabaseLoaded = true;
            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                document.head.appendChild(script);
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                });
                if (window.supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
            } catch (e) {
                console.error('Failed to load Supabase:', e);
            }
        }

        // Fetch notes from Supabase
        async function fetchNotes(bathhouseName) {
            await loadSupabase();
            if (!supabase) return [];
            try {
                const { data, error } = await supabase
                    .from('notes')
                    .select('*')
                    .eq('bathhouse_name', bathhouseName)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching notes:', error);
                    return [];
                }
                return data || [];
            } catch (e) {
                console.error('Error fetching notes:', e);
                return [];
            }
        }

        // Save note to Supabase
        async function saveNoteToSupabase(bathhouseName, noteText, authorName = 'Anonymous') {
            await loadSupabase();
            if (!supabase) return false;
            try {
                const { data, error } = await supabase
                    .from('notes')
                    .insert([{
                        bathhouse_name: bathhouseName,
                        note_text: noteText,
                        author_name: authorName || 'Anonymous'
                    }]);

                if (error) {
                    console.error('Error saving note:', error);
                    return false;
                }
                return true;
            } catch (e) {
                console.error('Error saving note:', e);
                return false;
            }
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Legacy local storage (for backwards compatibility)
        function getNotes() {
            return JSON.parse(localStorage.getItem('saunaNotes') || '{}');
        }

        function getNote(saunaName) {
            return getNotes()[saunaName] || '';
        }

        // Favorites management
        function getFavorites() {
            return JSON.parse(localStorage.getItem('shvitzFavorites') || '[]');
        }

        function isFavorite(saunaName) {
            return getFavorites().includes(saunaName);
        }

        function toggleFavorite(saunaName) {
            const favorites = getFavorites();
            const index = favorites.indexOf(saunaName);
            if (index === -1) {
                favorites.push(saunaName);
            } else {
                favorites.splice(index, 1);
            }
            localStorage.setItem('shvitzFavorites', JSON.stringify(favorites));
            return index === -1; // returns true if now favorited
        }

        // Hash password using SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Check password
        async function checkPassword() {
            const input = document.getElementById('password-input');
            const errorMsg = document.getElementById('error-message');
            const hash = await hashPassword(input.value);

            if (hash === PASSWORD_HASH) {
                document.getElementById('password-screen').style.display = 'none';
                document.getElementById('map-screen').style.display = 'flex';
                initializeMap();
            } else {
                errorMsg.style.display = 'block';
                input.value = '';
                input.focus();
            }
        }

        // Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('password-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
            input.focus();
        });

        // Custom marker icons
        const customIcon = L.divIcon({
            className: 'custom-marker',
            iconSize: [12, 12],
            iconAnchor: [6, 6],
            popupAnchor: [0, -8]
        });

        const userIcon = L.divIcon({
            className: 'user-marker',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        let map = null;
        let userMarker = null;
        let userLat = null;
        let userLon = null;
        let currentSort = 'alpha';

        // Calculate distance between two points (Haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Check if bathhouse is open now
        function isOpenNow(hours) {
            if (!hours || hours.includes('Check') || hours.includes('appointment') || hours.includes('session')) {
                return null; // Unknown
            }

            const now = new Date();
            const day = now.getDay(); // 0=Sun, 1=Mon, etc.
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            const currentTime = currentHour * 60 + currentMin;

            // Parse common patterns
            if (hours.includes('Daily')) {
                const match = hours.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?\s*[–-]\s*(\d{1,2}):?(\d{2})?\s*(am|pm)?/i);
                if (match) {
                    let openHour = parseInt(match[1]);
                    let openMin = parseInt(match[2]) || 0;
                    let closeHour = parseInt(match[4]);
                    let closeMin = parseInt(match[5]) || 0;

                    if (match[3]?.toLowerCase() === 'pm' && openHour < 12) openHour += 12;
                    if (match[6]?.toLowerCase() === 'pm' && closeHour < 12) closeHour += 12;
                    if (match[3]?.toLowerCase() === 'am' && openHour === 12) openHour = 0;
                    if (match[6]?.toLowerCase() === 'am' && closeHour === 12) closeHour = 0;

                    const openTime = openHour * 60 + openMin;
                    const closeTime = closeHour * 60 + closeMin;

                    return currentTime >= openTime && currentTime < closeTime;
                }
            }

            // Mon-Fri / Sat-Sun patterns
            const isWeekday = day >= 1 && day <= 5;
            const isWeekend = day === 0 || day === 6;

            if (hours.includes('Mon') && hours.includes('Sat')) {
                const parts = hours.split(',');
                for (const part of parts) {
                    const weekdayMatch = part.match(/Mon[–-]Fri\s+(\d{1,2}):?(\d{2})?\s*(am|pm)?\s*[–-]\s*(\d{1,2}):?(\d{2})?\s*(am|pm)?/i);
                    const weekendMatch = part.match(/Sat[–-]Sun\s+(\d{1,2}):?(\d{2})?\s*(am|pm)?\s*[–-]\s*(\d{1,2}):?(\d{2})?\s*(am|pm)?/i);

                    if (isWeekday && weekdayMatch) {
                        let openHour = parseInt(weekdayMatch[1]);
                        let closeHour = parseInt(weekdayMatch[4]);
                        if (weekdayMatch[3]?.toLowerCase() === 'pm' && openHour < 12) openHour += 12;
                        if (weekdayMatch[6]?.toLowerCase() === 'pm' && closeHour < 12) closeHour += 12;
                        const openTime = openHour * 60 + (parseInt(weekdayMatch[2]) || 0);
                        const closeTime = closeHour * 60 + (parseInt(weekdayMatch[5]) || 0);
                        return currentTime >= openTime && currentTime < closeTime;
                    }
                    if (isWeekend && weekendMatch) {
                        let openHour = parseInt(weekendMatch[1]);
                        let closeHour = parseInt(weekendMatch[4]);
                        if (weekendMatch[3]?.toLowerCase() === 'pm' && openHour < 12) openHour += 12;
                        if (weekendMatch[6]?.toLowerCase() === 'pm' && closeHour < 12) closeHour += 12;
                        const openTime = openHour * 60 + (parseInt(weekendMatch[2]) || 0);
                        const closeTime = closeHour * 60 + (parseInt(weekendMatch[5]) || 0);
                        return currentTime >= openTime && currentTime < closeTime;
                    }
                }
            }

            return null; // Unable to parse
        }

        // Get directions URL
        function getDirectionsUrl(lat, lon, name) {
            return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&destination_place_id=${encodeURIComponent(name)}`;
        }

        // Get current data based on mode
        function getCurrentData() {
            return worldMode ? worldData : saunaData;
        }

        // Markers layer group
        let markersLayer = null;

        // Initialize map
        function initializeMap() {
            map = L.map('map').setView([51.5074, -0.1278], 11);

            // Greyscale map tiles (CartoDB Positron - clean greyscale, no API key)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            // Create markers layer
            markersLayer = L.layerGroup().addTo(map);

            // Add markers for current mode
            addMarkers();

            // Build list view
            buildListView();

            // Setup view toggle
            setupViewToggle();

            // Setup locate button
            setupLocateButton();

            // Setup sort buttons
            setupSortButtons();

            // Setup world toggle
            setupWorldToggle();
        }

        // Add markers to map
        function addMarkers() {
            const data = getCurrentData();

            data.forEach(sauna => {
                const marker = L.marker([sauna.lat, sauna.lon], { icon: customIcon });
                const saunaId = sauna.name.replace(/[^a-zA-Z0-9]/g, '_');

                const directionsUrl = getDirectionsUrl(sauna.lat, sauna.lon, sauna.name);
                const favClass = isFavorite(sauna.name) ? 'favorited' : '';
                const favHeart = isFavorite(sauna.name) ? '♥' : '♡';

                // Different popup content for London vs World
                let infoSection = '';
                if (worldMode) {
                    const typeTag = sauna.type ? `<span class="country-tag">${sauna.type}</span>` : '';
                    const countryTag = sauna.country ? `<span class="country-tag">${sauna.country}</span>` : '';
                    infoSection = `
                        ${typeTag}${countryTag}<span class="price-tag">${sauna.price}</span>
                        <p class="address">${sauna.address}</p>
                    `;
                } else {
                    const openStatus = isOpenNow(sauna.hours);
                    const openBadge = openStatus === true ? '<span class="open-badge">Open Now</span>' :
                                      openStatus === false ? '<span class="closed-badge">Closed</span>' : '';
                    infoSection = `
                        ${openBadge}<span class="price-tag">${sauna.price}</span>
                        <p class="address">${sauna.address}</p>
                        <p class="hours">${sauna.hours}</p>
                    `;
                }

                const websiteLink = sauna.website ? `<a href="${sauna.website}" target="_blank" rel="noopener noreferrer" class="website-link">Website</a>` : '';

                const popupContent = `
                    <div class="popup-inner">
                        <div class="popup-header">
                            <h3>${sauna.name}</h3>
                            <button class="favorite-btn ${favClass}" onclick="handleToggleFavorite('${sauna.name.replace(/'/g, "\\'")}', this)" title="Add to favorites">${favHeart}</button>
                        </div>
                        ${infoSection}
                        ${websiteLink}
                        <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="directions-link">Directions</a>
                    </div>
                    <div class="notes-section">
                        <label>Community Notes</label>
                        <div id="notes-list-${saunaId}" class="notes-list">Loading notes...</div>
                        <div class="add-note-form">
                            <input type="text" id="author-${saunaId}" placeholder="Your name (optional)" class="author-input" />
                            <textarea id="note-${saunaId}" placeholder="Share your experience..." class="note-input"></textarea>
                            <button type="button" class="save-note" onclick="handleSaveNote('${sauna.name.replace(/'/g, "\\'")}')">Add Note</button>
                            <div class="note-saved" id="saved-${saunaId}">Note added!</div>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, { maxWidth: 340 });

                // Load notes when popup opens
                marker.on('popupopen', async () => {
                    const notesContainer = document.getElementById('notes-list-' + saunaId);
                    if (notesContainer) {
                        const notes = await fetchNotes(sauna.name);
                        if (notes.length === 0) {
                            notesContainer.innerHTML = '<p class="no-notes">No notes yet. Be the first!</p>';
                        } else {
                            notesContainer.innerHTML = notes.map(n => `
                                <div class="shared-note">
                                    <p class="note-text">${n.note_text}</p>
                                    <p class="note-meta">— ${n.author_name}, ${formatDate(n.created_at)}</p>
                                </div>
                            `).join('');
                        }
                    }
                });

                markersLayer.addLayer(marker);
            });
        }

        // Refresh map for mode change
        function refreshMap() {
            markersLayer.clearLayers();
            addMarkers();

            // Update count
            const data = getCurrentData();
            document.getElementById('bathhouse-count').textContent = data.length + ' bathhouses';

            // Adjust view
            if (worldMode) {
                map.setView([30, 0], 2); // World view
            } else {
                map.setView([51.5074, -0.1278], 11); // London view
            }

            // Rebuild list
            buildListView(currentSort);
        }

        // Setup world toggle
        function setupWorldToggle() {
            const toggle = document.getElementById('world-toggle');
            toggle.addEventListener('change', (e) => {
                worldMode = e.target.checked;
                refreshMap();
            });
        }

        // Build list view
        function buildListView(sortBy = 'alpha') {
            const listView = document.getElementById('list-view');
            let sortedData = [...getCurrentData()];

            if (sortBy === 'alpha') {
                sortedData.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'distance' && userLat !== null) {
                sortedData.forEach(s => {
                    s._distance = getDistance(userLat, userLon, s.lat, s.lon);
                });
                sortedData.sort((a, b) => a._distance - b._distance);
            } else if (sortBy === 'open' && !worldMode) {
                sortedData.forEach(s => {
                    s._isOpen = isOpenNow(s.hours);
                });
                sortedData.sort((a, b) => {
                    if (a._isOpen === true && b._isOpen !== true) return -1;
                    if (b._isOpen === true && a._isOpen !== true) return 1;
                    return a.name.localeCompare(b.name);
                });
            } else if (sortBy === 'favorites') {
                const favorites = getFavorites();
                sortedData = sortedData.filter(s => favorites.includes(s.name));
                sortedData.sort((a, b) => a.name.localeCompare(b.name));
            }

            listView.innerHTML = sortedData.map(sauna => {
                const directionsUrl = getDirectionsUrl(sauna.lat, sauna.lon, sauna.name);
                const favClass = isFavorite(sauna.name) ? 'favorited' : '';
                const favHeart = isFavorite(sauna.name) ? '♥' : '♡';
                const distanceText = sauna._distance !== undefined ?
                    `<span class="list-distance">${sauna._distance.toFixed(1)} km</span>` : '';

                // Different display for world vs London
                let infoLine = '';
                if (worldMode) {
                    const typeTag = sauna.type ? `<span class="country-tag">${sauna.type}</span>` : '';
                    const countryTag = sauna.country ? `<span class="country-tag">${sauna.country}</span>` : '';
                    infoLine = `${typeTag}${countryTag}${distanceText}`;
                } else {
                    const openStatus = isOpenNow(sauna.hours);
                    const openBadge = openStatus === true ? '<span class="open-now">Open</span>' :
                                      openStatus === false ? '<span class="closed-now">Closed</span>' : '';
                    infoLine = `<span class="list-hours">${sauna.hours}</span>${openBadge}${distanceText}`;
                }

                const websiteLink = sauna.website ? `<a href="${sauna.website}" target="_blank" rel="noopener noreferrer" class="list-link" onclick="event.stopPropagation()">Website</a>` : '';

                return `
                    <div class="list-item" onclick="focusSauna(${sauna.lat}, ${sauna.lon})">
                        <span class="list-favorite ${favClass}" onclick="event.stopPropagation(); handleToggleFavoriteList('${sauna.name.replace(/'/g, "\\'")}', this)">${favHeart}</span>
                        <h3>${sauna.name} <span class="price-tag">${sauna.price}</span></h3>
                        <p class="list-address">${sauna.address}</p>
                        ${infoLine}
                        <br style="margin-top: 8px;">
                        ${websiteLink}
                        <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="list-link" onclick="event.stopPropagation()">Directions</a>
                    </div>
                `;
            }).join('');

            if (sortBy === 'favorites' && sortedData.length === 0) {
                listView.innerHTML = '<div class="list-item"><p style="color: #6b6156; font-style: italic;">No favorites yet. Click the heart icon to add some!</p></div>';
            }
        }

        // Setup sort buttons
        function setupSortButtons() {
            const alphaBtn = document.getElementById('sort-alpha');
            const distBtn = document.getElementById('sort-distance');
            const openBtn = document.getElementById('sort-open');
            const favBtn = document.getElementById('sort-favorites');

            alphaBtn.onclick = () => {
                currentSort = 'alpha';
                updateSortButtons();
                buildListView('alpha');
            };

            distBtn.onclick = () => {
                if (userLat === null) {
                    // Get location first
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            userLat = pos.coords.latitude;
                            userLon = pos.coords.longitude;
                            currentSort = 'distance';
                            updateSortButtons();
                            buildListView('distance');
                        },
                        () => alert('Enable location to sort by distance')
                    );
                } else {
                    currentSort = 'distance';
                    updateSortButtons();
                    buildListView('distance');
                }
            };

            openBtn.onclick = () => {
                currentSort = 'open';
                updateSortButtons();
                buildListView('open');
            };

            favBtn.onclick = () => {
                currentSort = 'favorites';
                updateSortButtons();
                buildListView('favorites');
            };
        }

        function updateSortButtons() {
            document.getElementById('sort-alpha').classList.toggle('active', currentSort === 'alpha');
            document.getElementById('sort-distance').classList.toggle('active', currentSort === 'distance');
            document.getElementById('sort-open').classList.toggle('active', currentSort === 'open');
            document.getElementById('sort-favorites').classList.toggle('active', currentSort === 'favorites');
        }

        // Toggle favorite from popup
        function handleToggleFavorite(saunaName, btn) {
            const isFav = toggleFavorite(saunaName);
            btn.textContent = isFav ? '♥' : '♡';
            btn.classList.toggle('favorited', isFav);
        }

        // Toggle favorite from list
        function handleToggleFavoriteList(saunaName, el) {
            const isFav = toggleFavorite(saunaName);
            el.textContent = isFav ? '♥' : '♡';
            el.classList.toggle('favorited', isFav);
            // Rebuild list if viewing favorites
            if (currentSort === 'favorites') {
                buildListView('favorites');
            }
        }

        // Focus on sauna from list
        function focusSauna(lat, lon) {
            document.getElementById('map').style.display = 'block';
            document.getElementById('list-container').style.display = 'none';
            document.getElementById('map-view-btn').classList.add('active');
            document.getElementById('list-view-btn').classList.remove('active');
            map.setView([lat, lon], 15);
        }

        // Setup view toggle
        function setupViewToggle() {
            const mapBtn = document.getElementById('map-view-btn');
            const listBtn = document.getElementById('list-view-btn');
            const mapEl = document.getElementById('map');
            const listEl = document.getElementById('list-container');

            mapBtn.onclick = () => {
                mapEl.style.display = 'block';
                listEl.style.display = 'none';
                mapBtn.classList.add('active');
                listBtn.classList.remove('active');
                map.invalidateSize();
            };

            listBtn.onclick = () => {
                mapEl.style.display = 'none';
                listEl.style.display = 'block';
                listBtn.classList.add('active');
                mapBtn.classList.remove('active');
                buildListView(currentSort);
            };
        }

        // Setup locate button
        function setupLocateButton() {
            const locateBtn = document.getElementById('locate-btn');

            locateBtn.onclick = () => {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported by your browser');
                    return;
                }

                locateBtn.textContent = 'Locating...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Store user location globally
                        userLat = lat;
                        userLon = lon;

                        // Switch to map view
                        document.getElementById('map').style.display = 'block';
                        document.getElementById('list-container').style.display = 'none';
                        document.getElementById('map-view-btn').classList.add('active');
                        document.getElementById('list-view-btn').classList.remove('active');

                        // Remove old marker
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }

                        // Add user marker
                        userMarker = L.marker([lat, lon], { icon: userIcon })
                            .bindPopup('<div class="popup-inner"><h3>You are here</h3></div>')
                            .addTo(map);

                        map.setView([lat, lon], 13);
                        locateBtn.textContent = 'Locate Me';
                    },
                    (error) => {
                        locateBtn.textContent = 'Locate Me';
                        alert('Unable to get your location. Please enable location access.');
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            };
        }

        // Handle save note
        async function handleSaveNote(saunaName) {
            const saunaId = saunaName.replace(/[^a-zA-Z0-9]/g, '_');
            const textarea = document.getElementById('note-' + saunaId);
            const authorInput = document.getElementById('author-' + saunaId);
            const savedMsg = document.getElementById('saved-' + saunaId);
            const notesContainer = document.getElementById('notes-list-' + saunaId);

            if (!textarea || !textarea.value.trim()) {
                return;
            }

            const noteText = textarea.value.trim();
            const authorName = authorInput?.value.trim() || 'Anonymous';

            // Save to Supabase
            const success = await saveNoteToSupabase(saunaName, noteText, authorName);

            if (success) {
                // Clear inputs
                textarea.value = '';
                if (authorInput) authorInput.value = '';

                // Show success message
                savedMsg.style.display = 'block';
                setTimeout(() => {
                    savedMsg.style.display = 'none';
                }, 2000);

                // Refresh notes list
                const notes = await fetchNotes(saunaName);
                if (notesContainer) {
                    if (notes.length === 0) {
                        notesContainer.innerHTML = '<p class="no-notes">No notes yet. Be the first!</p>';
                    } else {
                        notesContainer.innerHTML = notes.map(n => `
                            <div class="shared-note">
                                <p class="note-text">${n.note_text}</p>
                                <p class="note-meta">— ${n.author_name}, ${formatDate(n.created_at)}</p>
                            </div>
                        `).join('');
                    }
                }
            } else {
                alert('Failed to save note. Please try again.');
            }
        }

        // Modal functionality
        const modal = document.getElementById('sauna-modal');
        const addBtn = document.getElementById('add-sauna-btn');
        const closeBtn = document.querySelector('.close');
        const submissionType = document.getElementById('submission-type');
        const saunaSelect = document.getElementById('existing-sauna');
        const saunaForm = document.getElementById('sauna-form');

        // Populate dropdown
        saunaData.forEach(sauna => {
            const option = document.createElement('option');
            option.value = sauna.name;
            option.textContent = sauna.name;
            saunaSelect.appendChild(option);
        });

        addBtn.onclick = () => {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        };

        closeBtn.onclick = () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        window.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };

        submissionType.onchange = (e) => {
            const type = e.target.value;
            const saunaSelectGroup = document.getElementById('sauna-select-group');
            const saunaNameGroup = document.getElementById('sauna-name-group');
            const saunaAddressGroup = document.getElementById('sauna-address-group');
            const saunaWebsiteGroup = document.getElementById('sauna-website-group');

            if (type === 'review') {
                saunaSelectGroup.style.display = 'block';
                saunaNameGroup.style.display = 'none';
                saunaAddressGroup.style.display = 'none';
                saunaWebsiteGroup.style.display = 'none';
                document.getElementById('sauna-name').required = false;
                document.getElementById('sauna-address').required = false;
            } else if (type === 'new') {
                saunaSelectGroup.style.display = 'none';
                saunaNameGroup.style.display = 'block';
                saunaAddressGroup.style.display = 'block';
                saunaWebsiteGroup.style.display = 'block';
                document.getElementById('sauna-name').required = true;
                document.getElementById('sauna-address').required = true;
            } else {
                saunaSelectGroup.style.display = 'none';
                saunaNameGroup.style.display = 'none';
                saunaAddressGroup.style.display = 'none';
                saunaWebsiteGroup.style.display = 'none';
            }
        };

        saunaForm.onsubmit = (e) => {
            e.preventDefault();

            const formData = {
                type: document.getElementById('submission-type').value,
                existingSauna: document.getElementById('existing-sauna').value,
                name: document.getElementById('sauna-name').value,
                address: document.getElementById('sauna-address').value,
                website: document.getElementById('sauna-website').value,
                rating: document.querySelector('input[name="rating"]:checked')?.value,
                review: document.getElementById('review-text').value,
                reviewerName: document.getElementById('reviewer-name').value || 'Anonymous',
                reviewerEmail: document.getElementById('reviewer-email').value,
                timestamp: new Date().toISOString()
            };

            const submissions = JSON.parse(localStorage.getItem('saunaSubmissions') || '[]');
            submissions.push(formData);
            localStorage.setItem('saunaSubmissions', JSON.stringify(submissions));

            document.getElementById('success-msg').style.display = 'block';
            saunaForm.reset();

            setTimeout(() => {
                document.getElementById('success-msg').style.display = 'none';
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 2500);
        };
    </script>
</body>
</html>
